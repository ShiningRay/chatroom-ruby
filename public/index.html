    <html>
    <head>

    <title>aaaaaa</title>
    </head>
    <body>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="agility.min.js"></script>
<script type="text/javascript" src="EventEmitter.js"></script>
<script src="http://cdn.sockjs.org/sockjs-0.2.1.min.js"></script>


<script>
  $.extend(SockJS.prototype, EventEmitter.prototype)
  var sock = new SockJS(window.location.href+"chat");
  sock.onopen = function() {
    console.log("open");
    this.emit('open')
  };

  sock.onmessage = function(e) {
    console.log("message", e.data);
    var data = JSON.parse(e.data);
    this.emit('data', data);
    if(data.event){
      this.emit(data.event, data);
    }
  };

  sock.onclose = function() {
    this.emit('close')
    alert('close');
  };
  window.onbeforeunload = function(){
    sock.onclose = function () {};
    sock.close();
  };
  sock.send_data = function(data){
    this.send(JSON.stringify(data))
  } 
  var chat = $$({login:'', content: ''},
   '<li>\
   <span data-bind="login" class="login" />\
   <span data-bind="content" class="content" />\
   </li>', 
   '& { \
    list-style: none; \
   } \
    & .login { \
    margin-right: 10px; \
   } \
    ', {

  })

  var user_tmpl = $$({}, '<li><span data-bind="login"/></li>')

  var users_list = $$({
    model: {users:{}},
    view: {
      format: '<div><ul></ul></div>'
    },
    add_user: function(name){
      var user = $$(user_tmpl, {login: name})
      this.model.get('users')[name] = user
      this.append(user, 'ul')
    },
    remove_user: function(name){
      var users = this.model.get('users')
      var user = users[name];
      if(!user){return}
      delete users[name];
      user.destroy();
    }
  })

  var room = $$({
    view: {
      format: '<div><h2 data-bind="name"></h2><ul id="chats"></ul><input type="text" id="content"><button id="send">send</button></div> '
    } ,
    controller: {
      'create': function(){
        var self = this;
        sock.on('data', function(data){
          console.log('data')
          if(data.event){
            self.trigger(data.event, data)
          }
        });
        this.append(users_list);

      },
      'click button': function(event){
          var c = $.trim(this.view.$('#content').val());
          if(c.length > 0)
            say(c)
       },
       'say': function(event, data){
          this.append($$(chat, {login: data.source, content: data.data}), '#chats');
       },
       'leave': function(event, data){
         users_list.remove_user(data.source)
       },
       'join': function(event, data){
        users_list.add_user(data.source)
       }
    }
  });

  var rooms = $$({'room_name':''}, '<div><h1>select room</h1><input type="text" id="room_name" data-bind="room_name"><button>Join</button></div>',
  {
    'click button': function(){

      sock.send_data({action: 'join', data: this.model.get('room_name')})
      var self=this;
      wait_for_response(function(){
        $$.document.append(room);
        self.destroy()
      })
      
    }
  })

  sock.on('joined', function(data){
    room.model.set({'name': data.room});
  })
var login = $$({login:''}, '<div><input type="text" id="login" data-bind="login"><button>login</button>', {
  'click button' : function(){
    var name = this.model.get('login');
    sock.send_data({action: 'auth', login: name, name: name})
    var self = this;
    wait_for_response(function(){
      $$.document.append(rooms);
      self.destroy();
    })
  }
})

  $$.document.append(login)

function say(content){
  sock.send_data({action: 'say', data: content})
}

function wait_for_response(callback){
  sock.addEventListener('message', callback, true)
}

function receive_data(data){

}

</script> </body></html>   